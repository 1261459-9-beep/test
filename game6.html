<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beat Battle - FNF节奏游戏</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: linear-gradient(135deg, #2c0735, #1a0a25, #0f3460);
            font-family: 'Arial Rounded MT Bold', 'Segoe UI', Arial, sans-serif;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            color: white;
        }
        
        #game-container {
            position: relative;
            width: 900px;
            height: 600px;
            background: linear-gradient(to bottom, #1a0a25, #2c0735);
            border-radius: 20px;
            box-shadow: 0 0 30px rgba(255, 100, 200, 0.7),
                        0 0 60px rgba(150, 50, 255, 0.5);
            overflow: hidden;
            border: 8px solid #ff1e8d;
        }
        
        #stage {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 200px;
            background: linear-gradient(to top, #3a1c45, #2a0f35);
            border-top: 4px solid #ff1e8d;
            z-index: 1;
        }
        
        #player, #opponent {
            position: absolute;
            bottom: 40px;
            width: 180px;
            height: 220px;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center bottom;
            transition: transform 0.1s ease;
        }
        
        #player {
            left: 80px;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 180 220"><circle cx="90" cy="100" r="55" fill="%23ff5252"/><rect x="60" y="150" width="60" height="50" rx="15" fill="%23ff5252"/><circle cx="75" cy="90" r="10" fill="white"/><circle cx="105" cy="90" r="10" fill="white"/><circle cx="75" cy="90" r="5" fill="black"/><circle cx="105" cy="90" r="5" fill="black"/><path d="M80 120 Q90 130 100 120" stroke="black" stroke-width="3" fill="none"/></svg>');
            transform: scaleX(-1);
        }
        
        #opponent {
            right: 80px;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 180 220"><circle cx="90" cy="100" r="55" fill="%234cc9f0"/><rect x="60" y="150" width="60" height="50" rx="15" fill="%234cc9f0"/><circle cx="75" cy="90" r="10" fill="white"/><circle cx="105" cy="90" r="10" fill="white"/><circle cx="75" cy="90" r="5" fill="black"/><circle cx="105" cy="90" r="5" fill="black"/><path d="M80 125 Q90 120 100 125" stroke="black" stroke-width="3" fill="none"/></svg>');
        }
        
        #arrow-container {
            position: absolute;
            left: 180px;
            top: 0;
            bottom: 0;
            width: 540px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            z-index: 10;
        }
        
        .arrow-track {
            position: relative;
            height: 100px;
            margin: 10px 0;
            background: rgba(30, 10, 40, 0.6);
            border-radius: 50px;
            border: 3px solid #7a3bff;
            overflow: hidden;
        }
        
        .arrow-track::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 80px;
            background: rgba(255, 255, 255, 0.15);
            border-right: 4px solid #ffd700;
            z-index: 5;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.6);
        }
        
        .arrow {
            position: absolute;
            width: 70px;
            height: 70px;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            z-index: 10;
            filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.8));
        }
        
        /* 修复箭头颜色 - 确保所有方向都有正确颜色 */
        .arrow.up { 
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 70 70"><polygon points="35,15 60,50 50,50 50,55 20,55 20,50 10,50" fill="%23ffcc00"/></svg>'); 
        }
        .arrow.down { 
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 70 70"><polygon points="35,55 10,20 20,20 20,15 50,15 50,20 60,20" fill="%234cc9f0"/></svg>'); 
        }
        .arrow.left { 
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 70 70"><polygon points="15,35 50,10 50,20 55,20 55,50 50,50 50,60" fill="%23ff5252"/></svg>'); 
        }
        .arrow.right { 
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 70 70"><polygon points="55,35 20,10 20,20 15,20 15,50 20,50 20,60" fill="%234ade80"/></svg>'); 
        }
        
        .arrow.hit {
            transform: scale(1.3);
            opacity: 0.8;
            filter: drop-shadow(0 0 10px white) drop-shadow(0 0 20px yellow);
        }
        
        .arrow.miss {
            opacity: 0.3;
            transform: scale(0.8);
        }
        
        #judgment {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            font-size: 80px;
            font-weight: bold;
            opacity: 0;
            z-index: 30;
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.9);
            animation: judgment-fade 1s forwards;
        }
        
        @keyframes judgment-fade {
            0% { opacity: 1; transform: translate(-50%, -50%) scale(0.5); }
            50% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(1.5); }
        }
        
        .sick { color: #ffd700; text-shadow: 0 0 20px #ffd700; }
        .good { color: #4ade80; text-shadow: 0 0 15px #4ade80; }
        .bad { color: #ff9e6d; text-shadow: 0 0 10px #ff9e6d; }
        .miss { color: #ff5252; text-shadow: 0 0 15px #ff5252; }
        
        #score-container {
            position: absolute;
            bottom: 30px;
            right: 40px;
            text-align: right;
            z-index: 20;
            font-size: 28px;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.8);
        }
        
        #score {
            font-weight: bold;
            color: #ffd700;
            font-size: 42px;
            margin-top: 5px;
        }
        
        #combo {
            font-size: 24px;
            margin-top: 5px;
            color: #ff1e8d;
            font-weight: bold;
        }
        
        #accuracy {
            font-size: 24px;
            margin-top: 5px;
            color: #4ade80;
            font-weight: bold;
        }
        
        #combo.active {
            animation: combo-pulse 0.3s ease-in-out;
        }
        
        @keyframes combo-pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        
        #start-screen, #game-over {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(20, 5, 30, 0.92);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            text-align: center;
            padding: 20px;
        }
        
        #game-over {
            display: none;
        }
        
        h1 {
            font-size: 72px;
            margin-bottom: 20px;
            background: linear-gradient(to right, #ff1e8d, #ff5252, #ffc107, #4ade80, #4cc9f0);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-shadow: 0 0 15px rgba(255, 255, 255, 0.5);
            letter-spacing: -3px;
            margin-bottom: 40px;
            font-weight: 900;
            text-stroke: 1px rgba(255, 255, 255, 0.3);
        }
        
        .subtitle {
            font-size: 28px;
            margin-bottom: 40px;
            max-width: 700px;
            line-height: 1.4;
            color: #e0e0ff;
        }
        
        .instructions {
            background: rgba(40, 15, 60, 0.85);
            border: 3px solid #7a3bff;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            font-size: 22px;
            max-width: 600px;
            line-height: 1.5;
        }
        
        .instructions kbd {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid #ff1e8d;
            border-radius: 8px;
            padding: 3px 8px;
            margin: 0 2px;
            font-family: monospace;
            font-weight: bold;
            box-shadow: 0 0 5px rgba(255, 30, 141, 0.7);
        }
        
        button {
            background: linear-gradient(to bottom, #ff1e8d, #cc1670);
            color: white;
            border: none;
            padding: 20px 60px;
            font-size: 32px;
            border-radius: 50px;
            margin-top: 20px;
            cursor: pointer;
            font-weight: bold;
            letter-spacing: 2px;
            box-shadow: 0 5px 0 #9e0f5a,
                        0 0 30px rgba(255, 30, 141, 0.7),
                        0 0 60px rgba(255, 30, 141, 0.4);
            transition: all 0.1s ease;
            position: relative;
            overflow: hidden;
        }
        
        button:hover {
            background: linear-gradient(to bottom, #ff3a9d, #e01a7a);
            transform: translateY(-2px);
            box-shadow: 0 7px 0 #9e0f5a,
                        0 0 35px rgba(255, 30, 141, 0.8),
                        0 0 70px rgba(255, 30, 141, 0.5);
        }
        
        button:active {
            transform: translateY(3px);
            box-shadow: 0 2px 0 #9e0f5a,
                        0 0 25px rgba(255, 30, 141, 0.7),
                        0 0 50px rgba(255, 30, 141, 0.4);
        }
        
        button::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.3) 0%, rgba(255,255,255,0) 70%);
            transform: scale(0);
            transition: transform 0.5s ease;
            border-radius: 50%;
        }
        
        button:hover::after {
            transform: scale(1);
        }
        
        .start-hint {
            font-size: 24px;
            color: #ffd700;
            margin-top: 30px;
            animation: blink 1.5s infinite;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.7);
        }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        #beat-visualizer {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 8px;
            z-index: 15;
        }
        
        .beat-light {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }
        
        .beat-light.active {
            background: #ff1e8d;
            box-shadow: 0 0 20px #ff1e8d, 0 0 40px #ff1e8d;
            transform: scale(1.3);
        }
        
        .pulse {
            animation: pulse 0.6s ease-out;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(1.5); opacity: 0; }
        }
        
        .player-hit {
            animation: hit-effect 0.2s ease-out;
        }
        
        @keyframes hit-effect {
            0% { transform: translateX(0) scaleX(-1); }
            50% { transform: translateX(15px) scaleX(-1.1); }
            100% { transform: translateX(0) scaleX(-1); }
        }
        
        .opponent-hit {
            animation: hit-effect-opponent 0.2s ease-out;
        }
        
        @keyframes hit-effect-opponent {
            0% { transform: translateX(0); }
            50% { transform: translateX(-15px) scaleX(1.1); }
            100% { transform: translateX(0); }
        }
        
        /* 修复箭头位置 - 确保在轨道内居中 */
        .arrow-track:nth-child(1) .arrow { top: 15px; }
        .arrow-track:nth-child(2) .arrow { top: 15px; }
        .arrow-track:nth-child(3) .arrow { top: 15px; }
        .arrow-track:nth-child(4) .arrow { top: 15px; }
        
        /* 添加音符轨迹线 */
        .arrow-track::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 2px;
            background: rgba(255, 255, 255, 0.2);
            z-index: 1;
        }
    </style>
</head>
<body>
    <div id="game-container">
        <div id="stage"></div>
        <div id="player"></div>
        <div id="opponent"></div>
        
        <div id="arrow-container">
            <div class="arrow-track" id="track-up"><div class="arrow up"></div></div>
            <div class="arrow-track" id="track-down"><div class="arrow down"></div></div>
            <div class="arrow-track" id="track-left"><div class="arrow left"></div></div>
            <div class="arrow-track" id="track-right"><div class="arrow right"></div></div>
        </div>
        
        <!-- 移除了上方的血条和标题 -->
        
        <div id="score-container">
            <div id="score">0</div>
            <div id="combo">连击: 0</div>
            <div id="accuracy">准确率: 0%</div>
        </div>
        
        <div id="beat-visualizer">
            <div class="beat-light"></div>
            <div class="beat-light"></div>
            <div class="beat-light"></div>
            <div class="beat-light"></div>
        </div>
        
        <div id="judgment">SICK</div>
        
        <div id="start-screen">
            <h1>節奏大師</h1>
            <div class="subtitle">按任意鍵開始遊戲</div>
            <div class="instructions">
                遊戲控制鍵 (由上至下):<br>
                <kbd>D</kbd> = 上 &nbsp;&nbsp; <kbd>F</kbd> = 中上<br>
                <kbd>J</kbd> = 中下 &nbsp;&nbsp; <kbd>K</kbd> = 下
            </div>
            <button id="start-button">開始遊戲</button>
            <div class="start-hint">按任意鍵或點擊按鈕開始</div>
        </div>
        
        <div id="game-over">
            <h1>游戏结束</h1>
            <div class="subtitle" id="final-score">最终分数: 0</div>
            <button id="restart-button">再玩一次</button>
        </div>
    </div>

    <script>
        // 游戏变量
        const gameState = {
            playing: false,
            health: 100,
            score: 0,
            combo: 0,
            maxCombo: 0,
            notes: [],
            activeNotes: [],
            time: 0,
            songProgress: 0,
            bpm: 130,
            noteSpeed: 0.28,
            judgment: { sick: 0, good: 0, bad: 0, miss: 0 },
            lastBeat: 0,
            beatInterval: 0,
            currentBeat: 0,
            startTime: 0,
            totalNotes: 0,
            hitNotes: 0,
            accuracy: 0,
            lastHitSuccess: true,
            processedNotes: 0
        };
        
        // DOM 元素
        const gameContainer = document.getElementById('game-container');
        const player = document.getElementById('player');
        const opponent = document.getElementById('opponent');
        const scoreDisplay = document.getElementById('score');
        const comboDisplay = document.getElementById('combo');
        const accuracyDisplay = document.getElementById('accuracy');
        const judgmentDisplay = document.getElementById('judgment');
        const startScreen = document.getElementById('start-screen');
        const gameOverScreen = document.getElementById('game-over');
        const finalScoreDisplay = document.getElementById('final-score');
        const startButton = document.getElementById('start-button');
        const restartButton = document.getElementById('restart-button');
        const beatLights = document.querySelectorAll('.beat-light');
        const arrowTracks = document.querySelectorAll('.arrow-track');
        const trackElements = {
            0: document.getElementById('track-up'),
            1: document.getElementById('track-down'),
            2: document.getElementById('track-left'),
            3: document.getElementById('track-right')
        };
        
        // 生成完全随机的音符序列
        function generateRandomNotes() {
            const notes = [];
            let currentTime = 1000;
            const minInterval = 600;
            const maxInterval = 1200;
            
            // 生成40个完全随机的音符
            for (let i = 0; i < 40; i++) {
                const direction = Math.floor(Math.random() * 4);
                const interval = minInterval + Math.random() * (maxInterval - minInterval);
                
                notes.push({
                    time: currentTime,
                    direction: direction,
                    track: direction
                });
                
                currentTime += interval;
            }
            
            return notes;
        }
        
        // 初始化游戏
        function initGame() {
            // 重置游戏状态
            gameState.playing = true;
            gameState.health = 100;
            gameState.score = 0;
            gameState.combo = 0;
            gameState.maxCombo = 0;
            gameState.notes = generateRandomNotes();
            gameState.activeNotes = [];
            gameState.time = 0;
            gameState.songProgress = 0;
            gameState.bpm = 130;
            gameState.noteSpeed = 0.28;
            gameState.judgment = { sick: 0, good: 0, bad: 0, miss: 0 };
            gameState.lastBeat = Date.now();
            gameState.beatInterval = 60000 / gameState.bpm;
            gameState.currentBeat = 0;
            gameState.startTime = Date.now();
            gameState.totalNotes = gameState.notes.length;
            gameState.hitNotes = 0;
            gameState.accuracy = 0;
            gameState.lastHitSuccess = true;
            gameState.processedNotes = 0;
            
            // 更新UI
            scoreDisplay.textContent = '0';
            comboDisplay.textContent = '连击: 0';
            accuracyDisplay.textContent = `准确率: ${Math.round(gameState.accuracy)}%`;
            comboDisplay.className = '';
            
            // 隐藏开始屏幕
            startScreen.style.display = 'none';
            gameOverScreen.style.display = 'none';
            
            // 清除旧音符
            document.querySelectorAll('.arrow').forEach(note => {
                if (note.parentNode) {
                    note.parentNode.removeChild(note);
                }
            });
            
            // 开始游戏循环
            gameLoop();
        }
        
        // 游戏主循环
        function gameLoop() {
            if (!gameState.playing) return;
            
            const now = Date.now();
            gameState.time = now;
            gameState.songProgress = now - gameState.startTime;
            
            // 生成新音符
            generateNotes();
            
            // 更新音符位置
            updateNotes();
            
            // 检查 missed notes
            checkMissedNotes();
            
            // 检查游戏结束
            if (gameState.health <= 0) {
                endGame();
                return;
            }
            
            // 检查歌曲是否结束
            if (gameState.songProgress > 50000 && gameState.activeNotes.length === 0) {
                endGame();
                return;
            }
            
            requestAnimationFrame(gameLoop);
        }
        
        // 生成音符
        function generateNotes() {
            const currentTime = gameState.songProgress;
            
            // 提前4秒生成音符
            for (let i = gameState.notes.length - 1; i >= 0; i--) {
                const note = gameState.notes[i];
                if (note.time <= currentTime + 4000 && note.time >= currentTime) {
                    createNote(note.direction, note.track, note.time);
                    gameState.notes.splice(i, 1);
                }
            }
        }
        
        // 创建音符
        function createNote(direction, track, time) {
            const arrowContainer = document.querySelector('.arrow-track:nth-child(' + (track+1) + ')');
            const arrow = document.createElement('div');
            const directions = ['up', 'down', 'left', 'right'];
            
            arrow.className = `arrow ${directions[direction]}`;
            arrow.style.left = '100%';
            arrow.dataset.time = time;
            arrow.dataset.hit = 'false';
            arrow.dataset.order = gameState.processedNotes + gameState.activeNotes.length;
            
            arrowContainer.appendChild(arrow);
            
            // 保存到活动音符列表
            gameState.activeNotes.push({
                element: arrow,
                direction: direction,
                track: track,
                time: time,
                hit: false,
                order: gameState.processedNotes + gameState.activeNotes.length
            });
        }
        
        // 更新音符位置
        function updateNotes() {
            const containerWidth = document.querySelector('.arrow-track').offsetWidth;
            const judgeLine = 60;
            
            for (let i = gameState.activeNotes.length - 1; i >= 0; i--) {
                const note = gameState.activeNotes[i];
                const noteElement = note.element;
                
                // 计算音符位置
                const progress = Math.max(0, (gameState.songProgress - note.time) / 100);
                const position = containerWidth - (progress * gameState.noteSpeed * 100);
                
                // 更新音符位置
                noteElement.style.left = `${position}px`;
            }
        }
        
        // 检查未按下的音符
        function checkMissedNotes() {
            const judgeLine = 60;
            
            for (let i = gameState.activeNotes.length - 1; i >= 0; i--) {
                const note = gameState.activeNotes[i];
                const noteElement = note.element;
                
                if (!note.hit) {
                    const notePosition = parseInt(noteElement.style.left) || 0;
                    
                    // 如果音符已经通过判定线太远
                    if (notePosition < judgeLine - 60) {
                        noteElement.classList.add('miss');
                        showJudgment('miss', noteElement);
                        
                        // MISS会重置连击
                        gameState.combo = 0;
                        comboDisplay.textContent = `连击: ${gameState.combo}`;
                        comboDisplay.className = '';
                        gameState.judgment.miss++;
                        gameState.lastHitSuccess = false;
                        
                        note.hit = true;
                        
                        // 从DOM中移除
                        if (noteElement.parentNode) {
                            noteElement.parentNode.removeChild(noteElement);
                        }
                        
                        // 从activeNotes中移除
                        gameState.activeNotes.splice(i, 1);
                        gameState.processedNotes++;
                    }
                }
            }
        }
        
        // 显示判定结果
        function showJudgment(type, noteElement) {
            // 更新判定统计
            if (type !== 'miss') {
                gameState.judgment[type]++;
            }
            
            // 更新命中计数
            if (type !== 'miss') {
                gameState.hitNotes++;
            }
            gameState.accuracy = (gameState.hitNotes / gameState.totalNotes) * 100;
            accuracyDisplay.textContent = `准确率: ${Math.round(gameState.accuracy)}%`;
            
            // 显示判定文本
            judgmentDisplay.textContent = type.toUpperCase();
            judgmentDisplay.className = type;
            
            // 创建脉冲效果
            const pulse = document.createElement('div');
            pulse.className = 'pulse';
            pulse.style.position = 'absolute';
            pulse.style.left = `${noteElement.offsetLeft + noteElement.offsetWidth/2}px`;
            pulse.style.top = `${noteElement.offsetTop + noteElement.offsetHeight/2}px`;
            pulse.style.width = '20px';
            pulse.style.height = '20px';
            pulse.style.borderRadius = '50%';
            pulse.style.backgroundColor = type === 'sick' ? '#ffd700' : 
                                          type === 'good' ? '#4ade80' : 
                                          type === 'bad' ? '#ff9e6d' : '#ff5252';
            gameContainer.appendChild(pulse);
            
            // 移除脉冲元素
            setTimeout(() => {
                if (pulse.parentNode) {
                    pulse.parentNode.removeChild(pulse);
                }
            }, 1000);
            
            // 角色动画
            if (type !== 'miss') {
                player.classList.add('player-hit');
                opponent.classList.add('opponent-hit');
                
                setTimeout(() => {
                    player.classList.remove('player-hit');
                    opponent.classList.remove('opponent-hit');
                }, 200);
            }
        }
        
        // 更新生命值（简化，不再显示血条）
        function updateHealth(amount) {
            gameState.health = Math.max(0, Math.min(100, gameState.health + amount));
            
            // 游戏结束检查移到这里
            if (gameState.health <= 0) {
                endGame();
            }
        }
        
        // 更新分数
        function updateScore(judgmentType) {
            let points = 0;
            
            switch(judgmentType) {
                case 'sick':
                    points = 350 + gameState.combo * 6;
                    break;
                case 'good':
                    points = 200 + gameState.combo * 4;
                    break;
                case 'bad':
                    points = 80 + gameState.combo * 2;
                    break;
            }
            
            gameState.score += points;
            scoreDisplay.textContent = gameState.score;
            
            // 更新连击（按音符顺序）
            if (judgmentType !== 'miss') {
                if (gameState.lastHitSuccess) {
                    gameState.combo++;
                } else {
                    gameState.combo = 1;
                }
                gameState.lastHitSuccess = true;
                gameState.maxCombo = Math.max(gameState.maxCombo, gameState.combo);
                
                comboDisplay.textContent = `连击: ${gameState.combo}`;
                comboDisplay.className = 'active';
            } else {
                gameState.combo = 0;
                comboDisplay.textContent = `连击: ${gameState.combo}`;
                comboDisplay.className = '';
                gameState.lastHitSuccess = false;
            }
        }
        
        // 按键处理 - D、F、J、K 由上至下
        function handleKeyPress(key) {
            if (!gameState.playing) return;
            
            let direction = -1;
            let track = -1;
            
            // D、F、J、K 对应四个轨道（由上至下）
            switch(key) {
                case 'KeyD': // D = 第1轨道（上）
                    direction = 0;
                    track = 0;
                    break;
                case 'KeyF': // F = 第2轨道（中上）
                    direction = 1;
                    track = 1;
                    break;
                case 'KeyJ': // J = 第3轨道（中下）
                    direction = 2;
                    track = 2;
                    break;
                case 'KeyK': // K = 第4轨道（下）
                    direction = 3;
                    track = 3;
                    break;
                default:
                    return;
            }
            
            // 超级宽松的判定窗口
            const judgeLine = 60;
            const judgeWindow = { 
                sick: 80,
                good: 120,
                bad: 180
            };
            
            // 找最早出现的匹配音符
            let targetNote = null;
            let minOrder = Infinity;
            
            for (const note of gameState.activeNotes) {
                if (!note.hit && note.direction === direction && note.track === track) {
                    const notePosition = parseInt(note.element.style.left) || 0;
                    const distance = Math.abs(notePosition - judgeLine);
                    
                    if (distance < judgeWindow.bad) {
                        if (note.order < minOrder) {
                            minOrder = note.order;
                            targetNote = note;
                        }
                    }
                }
            }
            
            // 处理命中
            if (targetNote) {
                targetNote.hit = true;
                targetNote.element.classList.add('hit');
                
                // 确定判定类型
                const notePosition = parseInt(targetNote.element.style.left) || 0;
                const distance = Math.abs(notePosition - judgeLine);
                let judgmentType = 'bad';
                
                if (distance < judgeWindow.sick) {
                    judgmentType = 'sick';
                    updateHealth(6);
                } else if (distance < judgeWindow.good) {
                    judgmentType = 'good';
                    updateHealth(4);
                } else {
                    updateHealth(2);
                }
                
                // 显示判定并更新分数
                showJudgment(judgmentType, targetNote.element);
                updateScore(judgmentType);
                
                // 移除音符
                setTimeout(() => {
                    if (targetNote.element && targetNote.element.parentNode) {
                        targetNote.element.parentNode.removeChild(targetNote.element);
                        
                        const index = gameState.activeNotes.indexOf(targetNote);
                        if (index !== -1) {
                            gameState.activeNotes.splice(index, 1);
                            gameState.processedNotes++;
                        }
                    }
                }, 200);
            } else {
                // 误按处理
                const trackElement = document.querySelector('.arrow-track:nth-child(' + (track + 1) + ')');
                if (trackElement) {
                    showJudgment('bad', trackElement);
                    updateHealth(-2);
                    gameState.judgment.bad++;
                    gameState.lastHitSuccess = false;
                }
            }
        }
        
        // 结束游戏
        function endGame() {
            gameState.playing = false;
            
            // 计算最终准确率
            gameState.accuracy = (gameState.hitNotes / gameState.totalNotes) * 100;
            
            // 显示游戏结束屏幕
            finalScoreDisplay.textContent = `最终分数: ${gameState.score}\n最大连击: ${gameState.maxCombo}\n准确率: ${Math.round(gameState.accuracy)}%\nSICK: ${gameState.judgment.sick} | GOOD: ${gameState.judgment.good} | BAD: ${gameState.judgment.bad} | MISS: ${gameState.judgment.miss}`;
            gameOverScreen.style.display = 'flex';
        }
        
        // 事件监听
        startButton.addEventListener('click', initGame);
        restartButton.addEventListener('click', initGame);
        
        // 按任意鍵開始遊戲
        document.addEventListener('keydown', (e) => {
            // 如果遊戲還沒開始，按任意鍵開始遊戲
            if (!gameState.playing && startScreen.style.display !== 'none') {
                e.preventDefault();
                initGame();
                return;
            }
            
            // D、F、J、K 键 - 遊戲進行中的控制
            if (e.code === 'KeyD' || e.code === 'KeyF' ||
                e.code === 'KeyJ' || e.code === 'KeyK') {
                e.preventDefault();
                handleKeyPress(e.code);
            }
        });
        
        // 判定区高亮提示
        setInterval(() => {
            if (gameState.playing) {
                const now = Date.now() - gameState.startTime;
                
                // 预测即将到达判定区的音符
                for (const note of gameState.activeNotes) {
                    if (!note.hit) {
                        const timeToJudge = note.time - now + 500;
                        if (timeToJudge > 0 && timeToJudge < 300) {
                            const trackEl = trackElements[note.track];
                            if (trackEl) {
                                trackEl.classList.add('highlight');
                                setTimeout(() => {
                                    trackEl.classList.remove('highlight');
                                }, 500);
                            }
                        }
                    }
                }
            }
        }, 100);
        
        // 初始设置
        accuracyDisplay.textContent = `准确率: 0%`;
    </script>
</body>
</html>